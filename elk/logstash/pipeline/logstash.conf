# ===============================
# ðŸ§  logstash.conf â€” Miriam (versiÃ³n corregida 20/10/2025)
# ===============================

input {
  beats {
    port => 5044
  }
}

filter {
  ######################################################################
  # ðŸ§© 0ï¸âƒ£ Evitar conflicto entre [input][type] de Beats y el campo "input" de Cowrie
  ######################################################################
  if [input][type] {
    mutate {
      rename => { "[input][type]" => "[beat_input_type]" }
    }
  }

  ######################################################################
  # 1ï¸âƒ£ Detectar y extraer comandos Cowrie CMD
  ######################################################################
  ruby {
    code => '
      msg = event.get("message")
      orig = event.get("[event][original]")
      candidates = [msg, orig].compact

      candidates.each do |val|
        next unless val.is_a?(String)
        if val.start_with?("CMD:")
          clean = val.sub(/^CMD:\s*/, "")
          event.set("input_cmd", clean)
          event.set("command_input", clean)
          break
        end
      end
    '
  }

  ######################################################################
  # 2ï¸âƒ£ Parsear JSON solo si el campo message empieza por '{'
  ######################################################################
  if [message] =~ /^\s*\{/ {
    json {
      source => "message"
      target => "parsed"
    }
  }

  ######################################################################
  # 3ï¸âƒ£ Mover todos los campos del JSON al nivel raÃ­z
  ######################################################################
  ruby {
    code => '
      parsed = event.get("parsed")
      if parsed.is_a?(Hash)
        parsed.each { |k, v| event.set(k, v) }
        event.remove("parsed")
      end
    '
  }

  ######################################################################
  # 4ï¸âƒ£ Crear alias DestPort desde dst_port
  ######################################################################
  if [dst_port] {
    mutate {
      add_field => { "DestPort" => "%{[dst_port]}" }
      convert => { "DestPort" => "integer" }
    }
  }

  ######################################################################
  # 5ï¸âƒ£ Normalizar el timestamp
  ######################################################################
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
      timezone => "UTC"
    }
  }

  ######################################################################
  # 6ï¸âƒ£ Crear [source][ip] desde src_ip
  ######################################################################
  if [src_ip] {
    mutate { add_field => { "[source][ip]" => "%{src_ip}" } }
  }

  ######################################################################
  # 7ï¸âƒ£ GeoIP City (paÃ­s, ciudad, coordenadas)
  ######################################################################
  if [source][ip] and [source][ip] != "" {
    geoip {
      source => "src_ip"
      target => "geoip"
      database => "/usr/share/logstash/GeoIP/GeoLite2-City.mmdb"
      fields => ["city_name", "country_name", "continent_code", "location", "region_name", "timezone"]
      add_field => { "geoip_source" => "GeoLite2-City" }
    }
  }

  ######################################################################
  # 8ï¸âƒ£ GeoIP ASN (proveedor, red)
  ######################################################################
  if [source][ip] and [source][ip] != "" {
    geoip {
      source => "src_ip"
      target => "geoip_asn"
      database => "/usr/share/logstash/GeoIP/GeoLite2-ASN.mmdb"
      fields => ["AUTONOMOUS_SYSTEM_NUMBER", "AUTONOMOUS_SYSTEM_ORGANIZATION"]
      add_field => { "geoip_asn_source" => "GeoLite2-ASN" }
    }
  }

  ######################################################################
  # 8ï¸âƒ£.1ï¸âƒ£ Campos derivados para dashboards
  ######################################################################
  if [geoip_asn][AUTONOMOUS_SYSTEM_ORGANIZATION] {
    mutate {
      add_field => {
        "asn_org" => "%{[geoip_asn][AUTONOMOUS_SYSTEM_ORGANIZATION]}"
        "asn_num" => "%{[geoip_asn][AUTONOMOUS_SYSTEM_NUMBER]}"
      }
      convert => { "asn_num" => "integer" }
    }
  }

  ######################################################################
  # 8ï¸âƒ£.2ï¸âƒ£ Enriquecimiento: reputaciÃ³n IP desde YAML (con soporte CIDR)
  ######################################################################
  if [src_ip] {
    ruby {
      init => '
        require "yaml"
        require "ipaddr"
        begin
          @rep = YAML.load_file("/usr/share/logstash/GeoIP/ip_reputation.yml")
        rescue
          @rep = {}
        end

        # Separar claves exactas y CIDRs
        @ip_exact = {}
        @ip_cidrs = []
        @rep.each do |key, value|
          if key.include?("/")
            begin
              @ip_cidrs << [IPAddr.new(key), value]
            rescue
              next
            end
          else
            @ip_exact[key] = value
          end
        end
      '
      code => '
        ip = event.get("src_ip")
        rep = "unknown"
        if ip
          rep = @ip_exact[ip] if @ip_exact.key?(ip)
          unless rep != "unknown"
            begin
              ipaddr = IPAddr.new(ip)
              @ip_cidrs.each do |cidr, val|
                if cidr.include?(ipaddr)
                  rep = val
                  break
                end
              end
            rescue
            end
          end
        end
        # Asegurar siempre string plano
        event.set("ip_rep", rep.to_s)
      '
    }
  }

  ######################################################################
  # 9ï¸âƒ£ Compatibilidad con dashboards antiguos
  ######################################################################
  if [geoip][geo][location][lat] and [geoip][geo][location][lon] {
    mutate {
      add_field => {
        "[geoip][location][lat]" => "%{[geoip][geo][location][lat]}"
        "[geoip][location][lon]" => "%{[geoip][geo][location][lon]}"
      }
      convert => {
        "[geoip][location][lat]" => "float"
        "[geoip][location][lon]" => "float"
      }
    }
  }

  ######################################################################
  # ðŸ”Ÿ Limpieza de etiquetas innecesarias
  ######################################################################
  mutate { remove_tag => ["_jsonparsefailure"] }
}

######################################################################
# 1ï¸âƒ£1ï¸âƒ£ Salida a Elasticsearch
######################################################################
output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "logstash-cowrie-%{+YYYY.MM.dd}"
  }

  # âœ³ï¸ Debug opcional
  #stdout { codec => rubydebug }
}
